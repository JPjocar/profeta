<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NoIntuition</title>
   <link rel="stylesheet" href="static/uploadstyle.css">
     <link rel="shortcut icon" href="static/jakataicon.png" />
</head>
<body>
  <div class="glass">
    <h1>NoIntuition</h1>
    <div class="muted">Sube tu excel con columnas: id_venta, nombre_producto, fecha_venta y cantidad</div>
      <label for="file" class="custom-file-upload">
        Seleccionar archivo
    </label>
    <input id="file" type="file" accept=".xlsx,.xls,.csv" style="margin-top:14px;"/>

    <div class="row">
      <button id="btnUpload">Subir excel</button>
      <button id="btnCancel" type="button" class="hidden">Cancelar</button>
    </div>

    <div id="progressBox" class="bar hidden">
      <div id="progressText" style="text-align:center">Cargando excel…</div>
      <div id="progressPct" style="text-align:center" class="muted" style="margin-top:6px;"></div>
        <div class="flexo">
            <span class="loader"></span>
        </div>
    </div>

    <div id="alertBox" class="alert hidden"></div>
  </div>

<script>
  function getCookie(name){
    const v = `; ${document.cookie}`;
    const parts = v.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  const fileEl = document.getElementById("file");
  const btnUpload = document.getElementById("btnUpload");
  const btnCancel = document.getElementById("btnCancel");
  const progressBox = document.getElementById("progressBox");
  const progressText = document.getElementById("progressText");
  const progressPct = document.getElementById("progressPct");
  const alertBox = document.getElementById("alertBox");

  let xhr = null;

  function showError(msg){
    alertBox.textContent = msg;
    alertBox.classList.remove("hidden");
  }
  function clearError(){
    alertBox.classList.add("hidden");
    alertBox.textContent = "";
  }

  btnUpload.onclick = () => {
    clearError();
    const f = fileEl.files[0];
    if (!f){
        showError("Selecciona un archivo primero.");
        return;
    }

    const form = new FormData();
    form.append("file", f);

    xhr = new XMLHttpRequest();
    xhr.open("POST", "/upload/", true);
    xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));

    progressBox.classList.remove("hidden");
    btnCancel.classList.remove("hidden");
    progressText.textContent = "Cargando excel…";
    progressPct.textContent = "";

    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable){
        const pct = Math.round((e.loaded / e.total) * 100);
        progressPct.textContent = pct + "%";
      } else {
        progressPct.textContent = "";
      }
    };

    xhr.onload = () => {
      btnCancel.classList.add("hidden");
      if (xhr.status >= 200 && xhr.status < 300){
        const data = JSON.parse(xhr.responseText);
        if (data.ok){
          window.location.href = data.redirect || "/forecast/";
        } else {
          showError(data.error || "Error desconocido.");
        }
      } else {
        try {
          const data = JSON.parse(xhr.responseText);
          showError(data.error || "Error al subir/leer el archivo.");
        } catch {
          showError("Error al subir/leer el archivo.");
        }
      }
    };

    xhr.onerror = () => {
      btnCancel.classList.add("hidden");
      showError("Fallo de red durante la subida.");
    };

    xhr.send(form);
  };

  btnCancel.onclick = () => {
    if (xhr) xhr.abort();
    progressText.textContent = "Subida cancelada.";
    btnCancel.classList.add("hidden");
  };
</script>
</body>
</html>

