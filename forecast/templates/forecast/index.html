<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NoIntuition</title>
     <link rel="shortcut icon" href="../static/jakataicon.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cascadia+Code:ital,wght@0,200..700;1,200..700&family=Google+Sans+Code:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../static/indexstyle.css">
</head>
<body>
  <div class="wrap">
    <div class="glass panel">
      <div class="muted">Dataset: {{ dataset_name }}</div>

      <form method="post" style="margin-top:10px;">
        {% csrf_token %}
        <label>Producto</label>
        <input id="productInput" name="product_name" placeholder="Escribe o selecciona..." value="{{ product_name|default:'' }}" autocomplete="off"/>

        <label id="horizonLabel">
          Horizonte ({{ horizon_unit|default:"días" }}):
        </label>
        <input type="number" name="horizon_days" id="horizonInput" min="1"
               placeholder="Ej: 30" />
        <small id="horizonHelp">
          Máximo recomendado: {{ horizon_max|default:horizon_max_default }}
        </small>

          <label for="granularity">Frecuencia:</label>
            <select id="granularity" name="granularity">
              <option value="daily" {% if granularity == "daily" %}selected{% endif %}>Diario</option>
              <option value="monthly" {% if granularity == "monthly" %}selected{% endif %}>Mensual</option>
            </select>

        <button type="submit">Predecir</button>

        {% if horizon_max %}
          <div class="muted" style="margin-top:10px;">Máximo recomendado para este producto: {{ horizon_max }} días</div>
        {% endif %}
        {% if error %}
          <div class="error" style="margin-top:12px;">{{ error }}</div>
        {% endif %}
      </form>

      <div style="margin-top:14px;" class="muted">Productos (scroll, 100 por carga)</div>
      <div id="productList" class="list"></div>
    </div>

    <div class="glass panel">
      <div class="muted">Evaluación 80/20</div>
      <div style="display:flex; gap:16px; flex-wrap:wrap; margin-top:6px;">
        <div class="muted">MAE: {{ mae|default:"-" }}</div>
        <div class="muted">MAPE%: {{ mape|default:"-" }}</div>
          <div class="muted">MAE%: {{ nmae|default:"-" }}</div>
      </div>

      <div style="margin-top:14px;">
        <canvas id="chart"></canvas>
      </div>

      <div style="margin-top:14px;">
        <div id="muted" class="muted" style="margin-bottom:6px;">Predicción futura (días)</div>
        <div class="glass" style="padding:0 12px;">
          <table>
            <thead><tr><th>Fecha</th><th>Cantidad</th></tr></thead>
            <tbody>
              {% for d, y in table_rows %}
                <tr><td>{{ d }}</td><td>{{ y }}</td></tr>
              {% empty %}
                <tr><td colspan="2" class="muted">Aún no se ha generado predicción.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  {{ chart_payload|json_script:"chart-data" }}

<script>
     const sel = document.getElementById("granularity");
  const label = document.getElementById("horizonLabel");
  const help = document.getElementById("horizonHelp");
const muted = document.getElementById("muted");

  function refreshUI() {
    const g = sel.value;
    const maxDaily = {{ horizon_max_default_daily|default:90 }};
    const maxMonthly = {{ horizon_max_default_monthly|default:24 }};
    if (g === "monthly") {
      label.textContent = "Horizonte (meses):";
      help.textContent = "Máximo recomendado: " + maxMonthly;
      muted.textContent = "Predicción futura (Meses)"
    } else {
      label.textContent = "Horizonte (días):";
      help.textContent = "Máximo recomendado: " + maxDaily;
      muted.textContent = "Predicción futura (Dias)"
    }
  }
  sel.addEventListener("change", refreshUI);
  refreshUI();
  // Lista productos: paginado + filtro
  const listEl = document.getElementById("productList");
  const inputEl = document.getElementById("productInput");
  let page = 1, loading = false, hasMore = true, currentSearch = "";

  function addItems(items){
    for (const name of items){
      const div = document.createElement("div");
      div.className = "item";
      div.textContent = name;
      div.onclick = () => { inputEl.value = name; };
      listEl.appendChild(div);
    }
  }
  async function loadProducts(reset=false){
    if (loading || (!hasMore && !reset)) return;
    loading = true;
    if (reset){ page = 1; hasMore = true; listEl.innerHTML = ""; }
    const res = await fetch(`/api/products/?page=${page}&search=${encodeURIComponent(currentSearch)}`);
    const data = await res.json();
    addItems(data.items || []);
    hasMore = !!data.has_more;
    page += 1;
    loading = false;
  }
  listEl.addEventListener("scroll", () => {
    const nearBottom = listEl.scrollTop + listEl.clientHeight >= listEl.scrollHeight - 30;
    if (nearBottom) loadProducts(false);
  });
  let t=null;
  inputEl.addEventListener("input", () => {
    clearTimeout(t);
    t = setTimeout(() => { currentSearch = inputEl.value.trim(); loadProducts(true); }, 250);
  });
  loadProducts(true);

  // Gráfico
  const payload = JSON.parse(document.getElementById("chart-data").textContent);
  const labels = payload.labels || [];
  const hist = payload.hist || [];
  const yhat = payload.yhat || [];

  const ctx = document.getElementById("chart").getContext("2d");

  if (!labels.length){
    // Si no hay prediccion
    ctx.font = "14px system-ui";
    ctx.fillStyle = "rgba(234,240,255,0.8)";
    ctx.fillText("Genera una prediccion para visualizar el grafico", 10, 30);
  } else {
    new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "Historico", data: hist, spanGaps: true, borderWidth: 2 },
          { label: "Predicción", data: yhat, borderWidth: 2 },
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: "#eaf0ff" } } },
        scales: {
          x: { ticks: { color: "#eaf0ff" }, grid: { color: "rgba(255,255,255,0.08)" } },
          y: { ticks: { color: "#eaf0ff" }, grid: { color: "rgba(255,255,255,0.08)" } }
        }
      }
    });
  }
</script>
</body>
</html>
